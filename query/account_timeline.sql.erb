SELECT
  toots.uri,
  toots.created_at,
  toots.text,
  toots.spoiler_text
FROM statuses AS toots
  INNER JOIN accounts ON toots.account_id=accounts.id
  INNER JOIN users ON accounts.id=users.account_id
  LEFT JOIN media_attachments AS attachments ON toots.id=attachments.status_id
WHERE (accounts.domain IS NULL)
  AND (toots.reblog_of_id IS NULL)
  AND (accounts.locked='f')
  AND (accounts.silenced='f')
  AND (accounts.suspended='f')
  AND (users.disabled='f')
  AND (accounts.username='<%= params[:account] %>')
  <% if params[:visibility] == 'unlisted' %>
    AND (toots.visibility <= 1)
  <% else %>
    AND (toots.visibility = 0)
  <% end %>
  AND (toots.uri IS NOT NULL)
  AND (toots.text !~ '(\s|^)@[_a-zA-Z0-9]+(@[-.a-zA-Z0-9]+)?(\s|$)')
  <% if params[:actor_type] == 'Service' %>
    AND (accounts.actor_type='Service')
  <% elsif params[:actor_type] == 'Person' %>
    AND ((accounts.actor_type='Person') OR (accounts.actor_type IS NULL))
  <% end %>
  <% if params[:hashtag] %>
    AND (toots.text ~ '#<%= params[:hashtag] %>')
  <% end %>
  <% if params[:attachments] %>
    AND (attachments.id IS NOT NULL)
  <% end %>
GROUP BY
  toots.uri,
  toots.created_at,
  toots.text,
  toots.spoiler_text
ORDER BY toots.created_at DESC
LIMIT <%= params[:entries] %> OFFSET 0
